---
# tasks file for roles/pgbouncer

- name: Instala pgbouncer
  become: true
  apt:
    deb: '{{ pgbouncer_deb_url }}'
    force_apt_get: yes
    state: present

- name: Gera arquivo de configuração 'pgbouncer.ini'
  become: true
  template:
    src: pgbouncer.ini.j2
    dest: "{{ pgbouncer_config_ini_path }}"
    owner: postgres
    group: postgres

- name: Gera arquivo de usuarios e senhas 'userlist.txt'
  become: true
  template:
    src: userlist.txt.j2
    dest: "{{ pgbouncer_auth_file }}"
    owner: postgres
    group: postgres

- name: Copia arquivo de configuracao 'pb_hba.conf'
  become: true
  copy:
    src: pb_hba.conf
    dest: "{{ pgbouncer_auth_hba_file }}"
    owner: postgres
    group: postgres

- name: Certifica que o pgbouncer esta iniciado
  service:
    name: pgbouncer
    state: started

- name: Recarrega configuracao do pgbouncer
  become: true
  service:
    name: pgbouncer
    state: reloaded
