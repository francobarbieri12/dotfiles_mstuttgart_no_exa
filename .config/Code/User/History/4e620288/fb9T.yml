
- name: Realiza atualização dos bancos de dados '{{ db_to_update }}' com a nova versao do sistema
  hosts: webservers
  any_errors_fatal: true

  pre_tasks:

    - name: Envia notificação para o canal '{{ slack_channel }}'
      slack:
        channel: '{{ slack_channel }}'
        username: 'webhookbot'
        icon_emoji: 'robot_face'
        token: '{{ slack_token }}'
        msg: 'Atualizando *{{ db_to_update }}*.'
      when: slack_enable_notification | bool

  roles:
    - role: ansible-odoo

  post_tasks:

    - name: Para servico "{{ odoo_daemon }}"
      become: yes
      service:
        name: "{{ odoo_daemon }}"
        state: stopped

    - name: Atualizando banco de dados "{{ db_to_update  }}"
      remote_user: "{{ odoo_user }}"
      command: "{{ odoo_virtualenv_python_path }} {{ odoo_bin_path }} -d {{ db_to_update }} -u all -c {{ odoo_config_path }}/odoo.cfg --logfile={{ odoo_log_path }}/{{ db_to_update }}.log --workers=0 --load-language=pt_BR --i18n-overwrite --stop-after-init"
      register: command_result
      failed_when: command_result.rc != 0

    - name: Reinicia servico "{{ odoo_daemon }}"
      become: yes
      service:
        name: "{{ odoo_daemon }}"
        state: restarted

    - name: Envia notificação para o canal '{{ slack_channel }}'
      slack:
        channel: '{{ slack_channel }}'
        username: 'webhookbot'
        icon_emoji: 'robot_face'
        token: '{{ slack_token }}'
        msg: 'Atualização de *{{ db_to_update }}* encerrada!'
      when: slack_enable_notification | bool
